#!/bin/bash
# ↑ shebang: вказує системі, що файл треба виконувати через bash

echo "=== Lesson 8: Bash Security Automation ==="
# ↑ просто вивід заголовка в термінал

# -------------------------------------------------
# 0. ПЕРЕВІРКА ПРАВ ROOT
# -------------------------------------------------

if [ "$EUID" -ne 0 ]; then
# ↑ якщо Effective User ID не дорівнює 0 (тобто ми НЕ root)

  echo "[!] Будь ласка, запускай скрипт через sudo"
  # ↑ повідомляємо користувачу, що потрібні права root

  exit 1
  # ↑ зупиняємо виконання скрипта, щоб нічого не ламати
fi
# ↑ кінець перевірки root

# -------------------------------------------------
# 1. ПАРОЛЬНА ПОЛІТИКА (minlen >= 8)
# -------------------------------------------------

echo "[*] Перевірка мінімальної довжини пароля (minlen >= 8)"
# ↑ інформаційне повідомлення

PASS_MINLEN=$(grep pam_unix.so /etc/pam.d/common-password \
# ↑ шукаємо рядок з pam_unix.so у файлі конфігурації паролів

| grep -o 'minlen=[0-9]*' \
# ↑ витягуємо ТІЛЬКИ параметр minlen=ЧИСЛО

| head -n 1 \
# ↑ беремо ТІЛЬКИ перше значення (на випадок дублювання)

| cut -d= -f2)
# ↑ відрізаємо "minlen=" і залишаємо тільки число

if [ -z "$PASS_MINLEN" ]; then
# ↑ якщо змінна порожня (minlen взагалі не заданий)

  echo "[!] minlen не задано. Встановлюємо minlen=8"
  # ↑ повідомляємо, що виправляємо конфігурацію

  sed -i '/pam_unix.so/ s/$/ minlen=8/' /etc/pam.d/common-password
  # ↑ додаємо minlen=8 в кінець рядка pam_unix.so

elif [ "$PASS_MINLEN" -lt 8 ]; then
# ↑ якщо minlen заданий, але МЕНШЕ 8

  echo "[!] minlen=$PASS_MINLEN — занадто слабкий. Оновлюємо до 8"
  # ↑ повідомляємо про слабку політику

  sed -i 's/minlen=[0-9]*/minlen=8/' /etc/pam.d/common-password
  # ↑ замінюємо будь-яке значення minlen на 8

else
# ↑ якщо minlen >= 8

  echo "[+] Парольна політика в нормі (minlen=$PASS_MINLEN)"
  # ↑ підтвердження, що все добре

fi
# ↑ кінець перевірки парольної політики

# -------------------------------------------------
# 2. ФАЄРВОЛ (UFW)
# -------------------------------------------------

echo "[*] Перевірка фаєрволу UFW"
# ↑ повідомлення користувачу

if ! command -v ufw >/dev/null 2>&1; then
# ↑ перевіряємо, чи команда ufw існує в системі

  echo "[!] UFW не встановлений. Встановлюємо..."
  # ↑ повідомляємо про встановлення

  apt update
  # ↑ оновлюємо список пакетів

  apt install ufw -y
  # ↑ встановлюємо ufw без додаткових питань

fi
# ↑ кінець перевірки наявності ufw

if ufw status | grep -qi inactive; then
# ↑ перевіряємо, чи фаєрвол НЕАКТИВНИЙ

  echo "[!] UFW вимкнений. Вмикаємо..."
  # ↑ повідомлення

  ufw --force enable
  # ↑ вмикаємо фаєрвол без підтвердження

else
# ↑ якщо ufw уже активний

  echo "[+] UFW уже активний"
  # ↑ повідомлення

fi
# ↑ кінець блоку UFW

# -------------------------------------------------
# 3. ЗАБОРОНА ROOT LOGIN ЧЕРЕЗ SSH
# -------------------------------------------------

echo "[*] Забороняємо root login через SSH"
# ↑ інформуємо, що налаштовуємо SSH

SSHD_CONFIG="/etc/ssh/sshd_config"
# ↑ шлях до конфігурації SSH-сервера

if grep -q "^PermitRootLogin" "$SSHD_CONFIG"; then
# ↑ якщо параметр PermitRootLogin уже існує

  sed -i 's/^PermitRootLogin.*/PermitRootLogin no/' "$SSHD_CONFIG"
  # ↑ замінюємо будь-яке значення на "no"

else
# ↑ якщо параметра взагалі немає

  echo "PermitRootLogin no" >> "$SSHD_CONFIG"
  # ↑ додаємо його в кінець файлу

fi
# ↑ кінець налаштування SSH

systemctl restart ssh
# ↑ перезапускаємо SSH, щоб зміни набули чинності

echo "[+] Root login через SSH заборонений"
# ↑ підтвердження

# -------------------------------------------------
# 4. АВТОМАТИЧНІ ОНОВЛЕННЯ
# -------------------------------------------------

echo "[*] Вмикаємо автоматичні оновлення"
# ↑ повідомлення

apt install unattended-upgrades -y
# ↑ встановлюємо пакет автооновлень

systemctl enable unattended-upgrades
# ↑ вмикаємо сервіс при старті системи

systemctl start unattended-upgrades
# ↑ запускаємо сервіс одразу

echo "[+] Автоматичні оновлення увімкнені"
# ↑ підтвердження

# -------------------------------------------------
# 5. БЛОКУВАННЯ ПІСЛЯ НЕВДАЛИХ ВХОДІВ
# -------------------------------------------------

echo "[*] Налаштовуємо блокування після 5 невдалих входів"
# ↑ повідомлення

PAM_FILE="/etc/pam.d/common-auth"
# ↑ файл PAM-автентифікації

if ! grep -q pam_faillock.so "$PAM_FILE"; then
# ↑ якщо pam_faillock ще НЕ налаштований

  sed -i '1i auth required pam_faillock.so preauth deny=5 unlock_time=900' "$PAM_FILE"
  # ↑ додаємо правило ДО перевірки пароля

  sed -i '/pam_unix.so/a auth [default=die] pam_faillock.so authfail deny=5 unlock_time=900' "$PAM_FILE"
  # ↑ додаємо правило ПІСЛЯ невдалого пароля

fi
# ↑ кінець блоку fail-lock

echo "[+] Блокування після 5 спроб налаштоване"
# ↑ підтвердження

echo "=== CIS hardening завершено успішно ==="
# ↑ фінальне повідомлення
